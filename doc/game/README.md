# 游戏规则与细节

## 游戏规则

四键垂直下落式音游，分为方块和面条两种元素。四条轨道是完全的并行关系，因此下面的讨论只针对一条轨道。

### 概念

系统概念：

- 刷新（update）。根据事件更新对象属性。每隔一定时间进行一次。
- 绘图（draw）。每隔 1/60 秒将所有要用到的数据锁存在一个缓冲区中。VGA 模块用到的数据一定只能从这个缓冲区中取。并且这个 1/60 秒一定要与 VGA 的 1/60 秒同步。
- 如果是实时维护要显示的颜色，实施维护的操作可以介于刷新和绘图之间。

基本概念：

- 对象。一个方块或一个面条是一个对象。
- 对象时间点。一个方块有一个对象时间点，一个面条有两个对象时间点（起始和终止）。
- 对象属性。所有对象都有一个属性：是否已“消失”，一开始没有消失。面条对象有一个额外属性，表明该面条对象是否被“遗弃”，一开始面条没有被遗弃。
- 按下事件、放开事件。键盘按下和放开的那一刻都被看作一个事件。
- 成绩。Perfect，Great，Good，OK，Miss 的数量。
- 连击数。

### 刷新的伪代码

对于每一条轨道：

```c++
void on_update()
{
	if (没有下一个对象时间点) // 打完了   在update_signle_track里面实现，需要维护一个内部变量i即要访问第i个对象时间点，每次利用connect_BRAM访问一个对象时间点后i+1 。打完后sig_done=1。single_track_judge 和 connect_BRAM 停止运行
		return;
	if (事件发生)//在single_track_judge里面实现 ，上面的
	{
		if (按下事件)
		{
			if (下一个对象是方块)
			{
				if (太早)
					return;
				else
					消失, 更新成绩, 更新“下一个对象”, 更新“下一个对象时间点”, 更新连击数; // 0
			}
			else // 下一个对象是面条
			{
				if (下一个对象时间点是面条起始)
				{
					if (太早)
						return;
					else
					{
						if (早到 miss)
							遗弃面条; // 1
						更新成绩, 更新“下一个对象时间点”, 更新连击数; // 2
					}
				}
				else // 下一个对象时间点是面条终止
				{
					// 此时面条一定被遗弃，啥也不做。
				}
			}
		}
		else // 放开事件
		{
			if (下一个对象是方块)
			{
				// 啥也不做。
			}
			else // 下一个对象是面条
			{
				if (下一个对象时间点是面条起始)
				{
					// 啥也不做。
				}
				else // 下一个对象时间点是面条终止
				{
					if (太早)
						遗弃面条, 连击数清零; // 3
					else
					{
						// 如果面条已被遗弃，更新成绩时最多记 OK。
						消失, 更新成绩, 更新“下一个对象”, 更新“下一个对象时间点”, 更新连击数; // 4
					}
				}
			}
		}
	}
	else // 没有事件发生
	{
		if (下一个对象是方块)
		{
			if (太晚)
				消失, 更新成绩, 更新“下一个对象”, 更新“下一个对象时间点”, 连击数清零; // 5
			// 否则啥也不干
		}
		else // 下一个对象是面条
		{
			if (下一个对象时间点是面条起始)
			{
				if (太晚)
					更新成绩, 更新“下一个对象时间点”, 连击数清零; // 6
				// 否则啥也不干。
			}
			else // 下一个对象时间点是面条终止
			{
				if (太晚)
					消失, 更新成绩, 更新“下一个对象”, 更新“下一个对象时间点”, 连击数清零; // 7
			}
		}
	}
}
```

对于轨道合并：

```c++
void on_update_all()
{
	本次连击 = 四个连击增量累加（清零不算）;
	if (清零)
		连击 = 本次连击;
	else
		连击 += 本次连击;

	成绩直接加上各自增量;
}
```

## 编码

### `.song` 文件

`.song` 文件是歌曲文件，采样率 44100。位宽为 8。

| 字数 |     说明     |
| :--: | :----------: |
| $n$  | 8 位的采样。 |

### `.preview` 文件

`.preview` 文件是用于预览的音频文件（可选），采样率 44100。位宽为 8。

| 字数 |     说明     |
| :--: | :----------: |
| $n$  | 8 位的采样。 |

### `.beatmap` 文件

`.beatmap` 文件是存时间点的文件，位宽为 24，只有低 20 位有效（约 17 分钟），最高 4 位保留。

| 字数  |              说明              |
| :---: | :----------------------------: |
|   1   | 第一个轨道的时间点数量 $N_1$。 |
| $N_1$ |      时间点，单位为毫秒。      |
|   1   | 第二个轨道的时间点数量 $N_2$。 |
| $N_2$ |      时间点，单位为毫秒。      |
|   1   | 第三个轨道的时间点数量 $N_3$。 |
| $N_3$ |      时间点，单位为毫秒。      |
|   1   | 第四个轨道的时间点数量 $N_4$。 |
| $N_4$ |      时间点，单位为毫秒。      |

地址线 13 位。

### `.object` 文件

`.object` 文件是存对象的文件，位宽为 4。

| 字数  |              说明              |
| :---: | :----------------------------: |
|   4   |  第一个轨道的对象数量 $M_1$。  |
| $M_1$ | `{ (保留), 遗弃, 消失, 面条 }` |
|   4   |  第二个轨道的对象数量 $M_2$。  |
| $M_2$ | `{ (保留), 遗弃, 消失, 面条 }` |
|   4   |  第三个轨道的对象数量 $M_3$。  |
| $M_3$ | `{ (保留), 遗弃, 消失, 面条 }` |
|   4   |  第四个轨道的对象数量 $M_4$。  |
| $M_4$ | `{ (保留), 遗弃, 消失, 面条 }` |

地址线 13 位。

### `.pixel` 文件

`.pixel` 文件是存“像素位置”的文件，位宽为 32。

| 字数  |              说明              |
| :---: | :----------------------------: |
|   1   | 第一个轨道的时间点数量 $N_1$。 |
| $N_1$ | 像素位置，单位为像素乘以 256。 |
|   1   | 第二个轨道的时间点数量 $N_2$。 |
| $N_2$ | 像素位置，单位为像素乘以 256。 |
|   1   | 第三个轨道的时间点数量 $N_3$。 |
| $N_3$ | 像素位置，单位为像素乘以 256。 |
|   1   | 第四个轨道的时间点数量 $N_4$。 |
| $N_4$ | 像素位置，单位为像素乘以 256。 |

地址线 13 位。

### `.timing` 文件

`.timing` 文件是存关键时间点的文件，位宽为 32。

| 字数 |                             说明                             |
| :--: | :----------------------------------------------------------: |
|  1   |                     关键时间点数量 $T$。                     |
|  1   |     高 12 位：保留。低 20 位：歌曲持续时间，单位为毫秒。     |
| $T$  | 高 12 位：该时间点之后的移动速度，单位为 256 倍像素每毫秒。低 20 位：时间点，单位为毫秒。 |

地址线 12 位。

### 谱面占用 BRAM 资源汇总

|    内容    | 占用 BRAM |      最大容量       |
| :--------: | :-------: | :-----------------: |
| `.beatmap` |    5.5    |   8188 个时间点。   |
| `.object`  |     1     |    8176 个对象。    |
|  `.pixel`  |    7.5    |  8188 个像素位置。  |
| `.timing`  |    4.5    | 4094 个关键时间点。 |
|    总计    |   18.5    |          -          |

预计还剩 13.5 个 36Kb BRAM，即 62 KB 剩余空间。

注：该部分是之前的统计，没有更新。但已知新的版本占用空间减小了。

### `.skin` 文件

`.skin` 文件是全局的皮肤文件，位宽为 16。其中最高四位保留。

|            字数            |                 说明                 |
| :------------------------: | :----------------------------------: |
| $10 \times (24 \times 20)$ |     数字 $0$ 到数字 $9$ 的图片。     |
| $5 \times (24 \times 64)$  | 小 Perfect, Great, Good, Bad, Miss。 |
| $1 \times (36 \times 60)$  |              方块图片。              |
| $2 \times (18 \times 60)$  |    面条起始图片（未遗弃、遗弃）。    |
| $2 \times (18 \times 60)$  |    面条结尾图片（未遗弃、遗弃）。    |
|  $2 \times (1 \times 60)$  |    面条中间图片（未遗弃、遗弃）。    |
| $1 \times (60 \times 60)$  |          按键指示按下图片。          |
| $1 \times (60 \times 60)$  |          按键指示放开图片。          |

共 26280 个像素。占用 13 个 36Kb BRAM。

