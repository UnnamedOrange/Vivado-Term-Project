# 游戏规则与细节

## 游戏规则

四键垂直下落式音游，分为方块和面条两种元素。四条轨道是完全的并行关系，因此下面的讨论只针对一条轨道。

### 概念

系统概念：

- 刷新（update）。 根据事件更新对象属性。每隔一定时间进行一次。
- 绘图（draw）。每隔 1/60 秒将所有要用到的数据锁存在一个缓冲区中。VGA 模块用到的数据一定只能从这个缓冲区中取。并且这个 1/60 秒一定要与 VGA 的 1/60 秒同步。
- 如果是实时维护要显示的颜色，实施维护的操作可以介于刷新和绘图之间。

基本概念：

- 对象。一个方块或一个面条是一个对象。
- 对象时间点。一个方块有一个对象时间点，一个面条有两个对象时间点（起始和终止）。
- 对象属性。所有对象都有一个属性：是否已“消失”，一开始没有消失。面条对象有一个额外属性，表明该面条对象是否被“遗弃”，一开始面条没有被遗弃。
- 按下事件、放开事件。键盘按下和放开的那一刻都被看作一个事件。
- 成绩。Perfect，Great，Good，OK，Miss 的数量。
- 连击数。

### 刷新的伪代码

对于每一条轨道：

```c++
void on_update()
{
	if (没有下一个对象时间点) // 打完了
		return;
	if (事件发生)
	{
		if (按下事件)
		{
			if (下一个对象是方块)
			{
				if (太早)
					return;
				else
					消失, 更新成绩, 更新“下一个对象”, 更新“下一个对象时间点”, 更新连击数;
			}
			else // 下一个对象是面条
			{
				if (下一个对象时间点是面条起始)
				{
					if (太早)
						return;
					else
					{
						if (早到 miss)
							遗弃面条;
						更新成绩, 更新“下一个对象时间点”, 更新连击数;
					}
				}
				else // 下一个对象时间点是面条终止
				{
					// 此时面条一定被遗弃，啥也不做。
				}
			}
		}
		else // 放开事件
		{
			if (下一个对象是方块)
			{
				// 啥也不做。
			}
			else // 下一个对象是面条
			{
				if (下一个对象时间点是面条起始)
				{
					// 啥也不做。
				}
				else // 下一个对象时间点是面条终止
				{
					if (太早)
						遗弃面条, 连击数清零;
					else
					{
						// 如果面条已被遗弃，更新成绩时最多记 OK。
						消失, 更新成绩, 更新“下一个对象”, 更新“下一个对象时间点”, 更新连击数;
					}
				}
			}
		}
	}
	else // 没有事件发生
	{
		if (下一个对象是方块)
		{
			if (太晚)
				消失, 更新成绩, 更新“下一个对象”, 更新“下一个对象时间点”, 连击数清零;
			// 否则啥也不干
		}
		else // 下一个对象是面条
		{
			if (下一个对象时间点是面条起始)
			{
				if (太晚)
					更新成绩, 遗弃面条, 更新“下一个对象时间点”, 连击数清零;
				// 否则啥也不干。
			}
			else // 下一个对象时间点是面条终止
			{
				if (太晚)
					消失, 更新成绩, 更新“下一个对象”, 更新“下一个对象时间点”, 连击数清零;
			}
		}
	}
}
```

对于轨道合并：

```c++
void on_update_all()
{
	本次连击 = 四个连击增量累加（清零不算）;
	if (清零)
		连击 = 本次连击;
	else
		连击 += 本次连击;

	成绩直接加上各自增量;
}
```